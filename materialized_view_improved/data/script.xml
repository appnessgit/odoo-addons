<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

        <record model="odoo.script" id="script_delete_cron_job_for_deleted_matview">
            <field name="name">Delete cron job for deleted matview</field>
            <field name="description"></field>
            <field name="script">
model_name = 'materialized.sql.view'
matviews = self.env[model_name].search([])
func = "openerp.addons.materialized_view_improved.model.materialized_sql_view_improved.refresh_materialized_view_job"
func_string = func + "('materialized.sql.view', [%i])"
matviews_to_delete = self.env[model_name]

for matview in matviews:
    try:
        self.env[matview.model_id.model]
    except KeyError:
        matviews_to_delete |= matview
        print matview.name + " in error! Suppression of linked cron and jobs... "
        job_ids = self.env['queue.job'].search([
            ('model_name', '=', model_name),
            ('func_string', '=', func_string % matview.id)
        ])
        if job_ids:
            print 'Jobs: %s are deleted' % job_ids
            job_ids.unlink()
        linked_refresh_cron = self.env['ir.cron'].search([
            ('model', '=', model_name),
            ('function', '=', '_refresh_model'),
            ('args', '=', '[[%i]]' % matview.id)
        ])
        if linked_refresh_cron:
            print 'Cron %s is deleted' % linked_refresh_cron.name
            linked_refresh_cron.unlink()
matviews_to_delete.unlink()
self.env.cr.commit()
            </field>
        </record>

    </data>
</openerp>